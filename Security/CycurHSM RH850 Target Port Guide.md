# Info
1. CycurHSM V2.7.14.r0 delivery: [SEC_ESS_HSM2_SFP_U2A8_GHS_XXX_V2.7.14.r0](file:///D:%5C01_Work%5C00_Renesas%5Chsm%5CSEC_ESS_HSM2_SFP_U2A8_GHS_XXX_V2.7.14.r0)
2. CycurHSM V2.7.13.r0 delivery: [SEC_ESS_HSM2_SFP_U2A8_GHS_XXX_V2.7.13.r0](file:///D:%5C01_Work%5C00_Renesas%5Chsm%5CSEC_ESS_HSM2_SFP_U2A8_GHS_XXX_V2.7.13.r0)
3. 1,2间已知区别：v2.7.13中的HSM.hex是single map mode,而v2.7.14中的HSM.hex是double map mode,在现有项目中应使用double map mode,后续需集成v2.7.14 (single/double map mode详见[[Address Map]])
4. CycurHSM Workshop: [hsm_workshop](file:///D:%5C01_Work%5C00_Renesas%5Chsm_workshop)

# Memory Map
## Single Map Mode

| Item                                 | Address     | Comments                                                                                                                                                           |
| ------------------------------------ | ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| HSM local RAM start                  | 0xFEDF 0000 | Exclusive access by HSM                                                                                                                                            |
| HSM local RAM end                    | 0xFEDF FFFF | 64kB local RAM                                                                                                                                                     |
| Config Area program FLASH start      | 0x007D 0000 |                                                                                                                                                                    |
| Config Area program FLASH end        | 0x007D 3FFF | 16kB post-build configuration area.<br><br>Note:the first 512B are left blank and not used by the configuration hex file. User specific data can be patched there. |
| Core app program FLASH start         | 0x007D 4000 |                                                                                                                                                                    |
| Core app program FLASH end           | 0x007F FCF0 | 160kB – 296B – 512B HSM firmware                                                                                                                                   |
| Core epilog FLASH start              | 0x007F FCF1 |                                                                                                                                                                    |
| Core epilog FLASH end                | 0x007F FF19 | 296B administration data containing items like SW version, signatures, MACs etc., followed by 512B empty space left for use by the customer.                       |
| EEPROM emulation FLASH block 0 start | 0xFF24 0000 |                                                                                                                                                                    |
| EEPROM emulation FLASH block 0 end   | 0xFF24 3FFF | 16KB -352B due to 704B erase counter preceding this block.                                                                                                         |
| EEPROM emulation FLASH block 1 start | 0xFF24 4000 |                                                                                                                                                                    |
| EEPROM emulation FLASH block 1 end   | 0xFF24 7FFF | 16KB -352B due to 704B erase counter preceding this block.                                                                                                         |
| EEPROM emulation FLASH block 2 start | 0xFF24 8000 |                                                                                                                                                                    |
| EEPROM emulation FLASH block 2 end   | 0xFF24 BFFF | 16KB -352B due to 704B erase counter preceding this block.                                                                                                         |
| EEPROM emulation FLASH block 3 start | 0xFF24 C000 |                                                                                                                                                                    |
| EEPROM emulation FLASH block 3 end   | 0xFF24 FFFF | 16KB -352B due to 704B erase counter preceding this block.                                                                                                         |
| HSM Bridge peripheral                | 0xFF1F 0000 | Base address of the HSM Bridge peripheral                                                                                                                          |
## Double Map Mode （Items same as above are not listed below)

| Item                            | Address     | Comments                                                                                                                                                           |
| ------------------------------- | ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Config Area program FLASH start | 0x003D 0000 |                                                                                                                                                                    |
| Config Area program FLASH end   | 0x003D 3FFF | 16kB post-build configuration area.<br><br>Note:the first 512B are left blank and not used by the configuration hex file. User specific data can be patched there. |
| Core app program FLASH start    | 0x003D 4000 |                                                                                                                                                                    |
| Core app program FLASH end      | 0x003F FCF0 | 160kB – 296B – 512B HSM firmware                                                                                                                                   |
| Core epilog FLASH start         | 0x003F FCF1 |                                                                                                                                                                    |
| Core epilog FLASH end           | 0x003F FF19 | 296B administration data containing items like SW version, signatures, MACs etc., followed by 512B empty space left for use by the customer.                       |
# Custom Memory Layout:
Supported for RH850_D3, RH850_D4, RH850_D5. OPBT9 and OPBT10 have to be adjusted to ensure proper functionality.
1. Offset of start address of HSM: \[-0x10000, 0x8000] in steps of 32kB(0x8000)
2. Size of HSM image: \[0x20000, 0x38000] in steps of 32kB(0x8000)
# Option Bytes Related to security
| option byte | comment                                             | address                                | setting                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ----------- | --------------------------------------------------- | -------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| OPBT13 (PE) | Valid area configuration setting in Double Map Mode | 0xFF32 13D4  <br><CSAk_base> + 0x3D4   | **b0: DBMAPSW0**<br>Double Map Mode Switching of Cluster 0<br>0: Bank B is mapped in valid area.<br>1: Bank A is mapped in valid area.<br><br>**b1: DBMAPSW1**<br>\[For U2A-EVA/U2A16] Double Map Mode Switching of Cluster 1<br>0: Bank D is mapped in valid area.<br>1: Bank C is mapped in valid area.<br>Note: Recommended bit values for U2A16 target both b0 and b1 set to 0 or both b0 and b1 set to 1.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ICUM_OPBT0  | ICU-M config                                        | 0xFF32 2700  <br><SSAk_base> + 0x700   | **b31-b28: ICUMON**<br>only the value 0000b enables the ICU-M to startup<br><br>b27-b24: Reserved<br>**b23-b20: ICUMUPGP1**<br>Value = 1111b (ICUMHA upgrade protection 1 is disabled)<br>Value = 0000b ICUMHA upgrade protection 1 is enabled)<br><br>b19-b16: Reserved<br>**b15-b12:  ICUMUPGP2**<br>Value = 1111b (ICUMHA upgrade protection 2 is disabled)<br>Value = 0000b ICUMHA upgrade protection 2 is enabled)<br><br>b11-b0: Reserved                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ICUM_OPBT1  | ICU-M reset vector                                  | 0xFF32 2704  <br><SSAk_base> + 0x704   | **b31-b0: ICUMRESV**<br>The value must be an address within the secure code flash.<br><br>Shall be:<br>- U2A8 single map mode = 0x007D0000<br>- U2A8 double map mode = 0x003D0000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ICUM_OPBT2  | Start address of secure code FLASH                  | 0xFF32 2708  <br><SSAk_base> + 0x708   | **b31-b0: ICUMRAC**<br>Start of the secure code FLASH area (HSM exclusive). (Because block size is 64kB, ICUMRAC\[15:0] is ignored.)<br><br>Shall be:<br>- U2A8 single map mode = 0x007D0000<br>- U2A8 double map mode = 0x003D0000<br><br>Note: The end of the secure code FLASH range is the end of the code FLASH area the above mentioned start address is located in.<br>![alt text\|1000](ICUMRAC.png)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ICUM_OPBT3  | Start address of secure data FLASH                  | 0xFF32 270C<br><br><SSAk_base> + 0x70C | **b31-b0: ICUMRAD**<br>Start of the secure data FLASH area (HSM exclusive).<br><br>Shall be:<br>- U2A8 = 0xFF240000<br><br>Note: The end of the secure data FLASH range is the end of the data FLASH area the above mentioned start address is located in.<br>![alt text\|1000](ICUMRAD.png)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ICUM_OPBT4  | Several configurations                              | 0xFF32 2710<br><br><SSAk_base> + 0x70C | b31-b29: Reserved<br>**b28: ICUMPEDBG**<br>PE independent debugging for ICU-M control<br>0b: enable<br>1b: disable<br><br>b27-b26: Reserved<br>**b25: ICUMCRF2**<br>Challenge and response for (C&R) authentication for ICUP<br>0b: enable<br>1b: disable/skip<br><br>**b24: ICUMCRF1**<br>Challenge and response for (C&R) authentication for PE-CPU<br>0b: enable<br>1b: disable/skip<br><br>b23-b18: Reserved<br>**b17: ICUMOPGPIO**<br>GPIO control by ICUM<br>0b: disable<br>1b: enable<br><br>b16: Reserved<br>**b15: HSIF_CRAUTH_NEED**<br>RHSIF Link Partner C&R Setting<br>0b: disable<br>1b: enable<br><br>b14-b12: Reserved<br>**b11-b10: STAC_ICUM_LRAM**<br>ICUM_LRAM initialization Mode<br>X0b: disable<br>01b: prohibited<br>11b: enable<br><br>**b9-b8: STAC_ICUM_PKCCA**<br>ICUM PKCC_RAM initialization Mode<br>X0b: disable<br>01b: prohibited<br>11b: enable<br><br>b7-b6: Reserved<br>**b5: ICUMOPWDVAC**<br>WDTA Variable Activation Code(VAC) selection<br>1b: VAC enabled<br>0b: VAC disabled<br><br>**b4 ICUMOPWDRUN**<br>WDTA start mode setting<br>0b: software triggered start mode<br>1b: automatic start<br><br>**b3 ICUMOPWDEN**<br>WDTA enable/disable<br>0b: WDTA is disabled<br>1b: WDTA is enabled<br><br>**b2-b0 ICUMOPWDOVF**<br>WDTA count clock setting<br>000b: 2^9 Macro clock periods<br>001b: 2^10 Macro clock periods<br>010b: 2^11 Macro clock periods<br>011b: 2^12 Macro clock periods<br>100b: 2^13 Macro clock periods<br>101b: 2^14 Macro clock periods<br>110b: 2^15 Macro clock periods<br>111b: 2^16 Macro clock periods |
# Enabling ICUMHA
To enable ICUMHA,   [[#^2bcdd5|ICUMRAC]] , [[#^2bcdd5|ICUMRAD]], [[#^2bcdd5|ICUMRESV]] shall be other than 0xFFFF FFFF. [[#^2bcdd5|ICUMON]] shall be 0x0.
Also, when ICUMHA is enabled, default start mode(WDTBA) must be disabled. Always select software trigger start mode by setting [[Option Byte#^1a40d7|OPBT0.OPWDRUNA]] = 0.
# Secure Boot
The RH850 U2A8 (R7F702301) cannot be configured through option bytes, and as long as the HSM is enabled, it always starts first. This means that sequential boot is the default boot mode for the U2B family.
For use cases when sequential boot it not required, the RH850 U2A and U2B families support a parallel boot emulation feature, which can be configured by ETAS on request. When enabled, the HSM releases the host core unconditionally as soon as possible during HSM startup. This feature can be used to reduce the host application startup time when a sequential boot is not required.
# HSM GPIO Pins
The ICUMHA and ICUMHB support 4 GPIO pins (P17_0, P17_1, P10_0 and P10_1). These pins are configured as output pins under control of ICUMH and the output level is low.